<!-- 
    Part 7 Reading - Passage + Questions
    Flow: Read passage → Answer questions → Submit → See results
-->
<div class="flex h-[calc(100vh-65px)] w-full flex-col bg-[#0f172a] font-sans text-white overflow-hidden">
    <!-- Header -->
    <header class="border-b border-white/5 bg-[#0f172a]/95 backdrop-blur-xl px-4 py-4 md:px-8 z-20 shadow-sm">
        <div class="mx-auto w-full flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm font-medium">
                <a routerLink="/" class="text-slate-400 hover:text-white transition-colors">Trang chủ</a>
                <span class="material-symbols-outlined text-slate-600 text-xs">chevron_right</span>
                <a routerLink="/toeic" class="text-slate-400 hover:text-white transition-colors">TOEIC</a>
                <span class="material-symbols-outlined text-slate-600 text-xs">chevron_right</span>
                <a routerLink="/toeic/part7" class="text-slate-400 hover:text-white transition-colors">Part 7</a>
                <span class="material-symbols-outlined text-slate-600 text-xs">chevron_right</span>
                <span class="text-white truncate max-w-[150px]">{{ passage?.title }}</span>
            </div>

            <!-- Progress indicator -->
            <div *ngIf="passage && !isSubmitted" class="flex items-center gap-2 text-sm">
                <span class="text-slate-400">{{ answeredCount }}/{{ passage.questions.length }}</span>
                <div class="w-24 h-2 bg-white/10 rounded-full overflow-hidden">
                    <div class="h-full bg-emerald-500 transition-all duration-300"
                        [style.width.%]="(answeredCount / passage.questions.length) * 100"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="flex items-center justify-center h-full">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500"></div>
        </div>

        <!-- Two Column Layout -->
        <div *ngIf="!isLoading && passage" class="h-full flex flex-col lg:flex-row">

            <!-- Left: Passage -->
            <div
                class="lg:w-1/2 h-1/2 lg:h-full overflow-y-auto border-b lg:border-b-0 lg:border-r border-white/10 p-4 md:p-8 no-scrollbar">
                <!-- Passage Header -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-emerald-400">{{ getTypeIcon(passage.type) }}</span>
                        <span class="text-emerald-400 text-sm font-medium">{{ getTypeLabel(passage.type) }}</span>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold text-white">{{ passage.title }}</h1>
                </div>

                <!-- Passage Content -->
                <div class="bg-white/5 rounded-xl p-6 border border-white/10">
                    <p class="text-slate-200 leading-relaxed whitespace-pre-line text-base md:text-lg">{{
                        passage.content }}</p>
                </div>
            </div>

            <!-- Right: Questions -->
            <div class="lg:w-1/2 h-1/2 lg:h-full overflow-y-auto p-4 md:p-8 no-scrollbar">
                <h2 class="text-lg font-semibold text-white mb-6">Câu hỏi</h2>

                <!-- Questions List -->
                <div class="space-y-6">
                    <div *ngFor="let question of passage.questions; let qIndex = index"
                        class="bg-white/5 rounded-xl p-5 border border-white/10" [ngClass]="{
                             'border-emerald-500/50': isSubmitted && isCorrect(question),
                             'border-red-500/50': isSubmitted && !isCorrect(question)
                         }">

                        <!-- Question Number & Text -->
                        <div class="flex items-start gap-3 mb-4">
                            <span
                                class="flex-shrink-0 flex items-center justify-center w-7 h-7 bg-emerald-500/20 rounded-full text-emerald-400 text-sm font-bold">
                                {{ qIndex + 1 }}
                            </span>
                            <p class="text-white">{{ question.question }}</p>
                        </div>

                        <!-- Options -->
                        <div class="space-y-2 ml-10">
                            <button *ngFor="let option of question.options; let oIndex = index"
                                (click)="selectAnswer(question.id, oIndex)" [disabled]="isSubmitted"
                                class="w-full flex items-center gap-3 p-3 rounded-lg border text-left transition-all text-sm"
                                [ngClass]="{
                                    'bg-white/5 border-white/10 hover:bg-white/10': !isSelected(question.id, oIndex) && !isSubmitted,
                                    'bg-emerald-500/20 border-emerald-500/50': (isSelected(question.id, oIndex) && !isSubmitted) || (isSubmitted && oIndex === question.correctAnswer),
                                    'bg-red-500/20 border-red-500/50': isSubmitted && isSelected(question.id, oIndex) && oIndex !== question.correctAnswer,
                                    'opacity-50': isSubmitted && oIndex !== question.correctAnswer && !isSelected(question.id, oIndex)
                                }">

                                <!-- Option Letter -->
                                <span
                                    class="flex-shrink-0 flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold"
                                    [ngClass]="{
                                        'bg-white/10 text-white': !isSelected(question.id, oIndex) && !isSubmitted,
                                        'bg-emerald-500 text-white': (isSelected(question.id, oIndex) && !isSubmitted) || (isSubmitted && oIndex === question.correctAnswer),
                                        'bg-red-500 text-white': isSubmitted && isSelected(question.id, oIndex) && oIndex !== question.correctAnswer
                                    }">
                                    {{ getOptionLetter(oIndex) }}
                                </span>

                                <!-- Option Text -->
                                <span class="flex-1" [ngClass]="{
                                          'text-white': isSelected(question.id, oIndex) || (isSubmitted && oIndex === question.correctAnswer),
                                          'text-slate-300': !isSelected(question.id, oIndex) && (!isSubmitted || oIndex !== question.correctAnswer)
                                      }">
                                    {{ option }}
                                </span>

                                <!-- Icons for submitted state -->
                                <span *ngIf="isSubmitted && oIndex === question.correctAnswer"
                                    class="material-symbols-outlined text-emerald-400 text-lg">check_circle</span>
                                <span
                                    *ngIf="isSubmitted && isSelected(question.id, oIndex) && oIndex !== question.correctAnswer"
                                    class="material-symbols-outlined text-red-400 text-lg">cancel</span>
                            </button>
                        </div>

                        <!-- Explanation (after submit) -->
                        <div *ngIf="isSubmitted && question.explanation"
                            class="mt-4 ml-10 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                            <div class="flex items-start gap-2">
                                <span class="material-symbols-outlined text-blue-400 text-sm">lightbulb</span>
                                <p class="text-slate-300 text-sm">{{ question.explanation }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div *ngIf="!isSubmitted" class="mt-8 sticky bottom-0 bg-[#0f172a] py-4">
                    <button (click)="submitAnswers()" [disabled]="!allQuestionsAnswered"
                        class="w-full flex items-center justify-center gap-2 px-6 py-4 rounded-xl font-medium transition-all"
                        [ngClass]="{
                                'bg-emerald-500 hover:bg-emerald-600 text-white': allQuestionsAnswered,
                                'bg-white/10 text-slate-500 cursor-not-allowed': !allQuestionsAnswered
                            }">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span>Nộp bài ({{ answeredCount }}/{{ passage.questions.length }})</span>
                    </button>
                </div>

                <!-- Results Summary -->
                <div *ngIf="isSubmitted" class="mt-8 p-6 bg-white/5 rounded-xl border border-white/10">
                    <div class="text-center">
                        <div class="text-4xl font-bold mb-2" [ngClass]="{
                                 'text-emerald-400': getScorePercentage() >= 70,
                                 'text-amber-400': getScorePercentage() >= 50 && getScorePercentage() < 70,
                                 'text-red-400': getScorePercentage() < 50
                             }">
                            {{ score }}/{{ passage.questions.length }}
                        </div>
                        <p class="text-slate-400 mb-6">
                            {{ getScorePercentage() >= 70 ? 'Xuất sắc!' : getScorePercentage() >= 50 ? 'Khá tốt!' : 'Cần
                            cố gắng thêm!' }}
                        </p>

                        <div class="flex flex-wrap gap-4 justify-center">
                            <button (click)="restartReading()"
                                class="flex items-center gap-2 px-5 py-2.5 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-sm">refresh</span>
                                <span>Làm lại</span>
                            </button>
                            <a routerLink="/toeic/part7"
                                class="flex items-center gap-2 px-5 py-2.5 bg-emerald-500 hover:bg-emerald-600 rounded-lg transition-colors">
                                <span>Bài đọc khác</span>
                                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Not Found -->
        <div *ngIf="!isLoading && !passage" class="flex flex-col items-center justify-center h-full">
            <span class="material-symbols-outlined text-slate-600 text-6xl mb-4">search_off</span>
            <p class="text-slate-400 mb-4">Không tìm thấy bài đọc</p>
            <a routerLink="/toeic/part7" class="text-emerald-400 hover:text-emerald-300">← Quay lại danh sách</a>
        </div>
    </main>
</div>