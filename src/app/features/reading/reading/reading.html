<div class="flex h-[calc(100vh-65px)] w-full flex-col bg-[#0f172a] font-sans text-white overflow-hidden">
    <!-- Header/Breadcrumb -->
    <header class="border-b border-white/5 bg-[#0f172a]/95 backdrop-blur-xl px-4 py-4 md:px-8 z-20 shadow-sm">
        <div class="mx-auto w-full flex items-center flex-wrap gap-2 text-sm font-medium">
            <button (click)="goBackToLevels()"
                class="flex items-center gap-2 transition-all hover:text-white hover:bg-white/5 px-3 py-1.5 rounded-lg"
                [class.text-blue-400]="!selectedLevel" [class.bg-blue-400/10]="!selectedLevel"
                [class.text-slate-400]="selectedLevel">
                <span class="material-symbols-outlined text-[1.2rem]">library_books</span>
                <span [class.hidden]="selectedLevel" class="md:inline">Luyện đọc</span>
            </button>
            <ng-container *ngIf="selectedLevel">
                <span class="material-symbols-outlined text-slate-600 text-xs">chevron_right</span>
                <button (click)="goBackToTopics()"
                    class="transition-all hover:text-white hover:bg-white/5 px-3 py-1.5 rounded-lg"
                    [class.text-blue-400]="!selectedTopic" [class.bg-blue-400/10]="!selectedTopic"
                    [class.text-slate-400]="selectedTopic">
                    {{ selectedLevel.name }}
                </button>
            </ng-container>
            <ng-container *ngIf="selectedTopic">
                <span class="material-symbols-outlined text-slate-600 text-xs">chevron_right</span>
                <button (click)="goBackToConversations()"
                    class="transition-all hover:text-white hover:bg-white/5 px-3 py-1.5 rounded-lg"
                    [class.text-blue-400]="!selectedConversation" [class.bg-blue-400/10]="!selectedConversation"
                    [class.text-slate-400]="selectedConversation">
                    {{ selectedTopic.name }}
                </button>
            </ng-container>
            <ng-container *ngIf="selectedConversation">
                <span class="material-symbols-outlined text-slate-600 text-xs">chevron_right</span>
                <span class="text-white bg-white/5 px-3 py-1.5 rounded-lg truncate max-w-[150px] md:max-w-none">{{
                    selectedConversation.title }}</span>
            </ng-container>
        </div>
    </header>

    <!-- Main Content -->
    <main #mainContainer (scroll)="onScroll($event)" class="flex-1 overflow-y-auto relative no-scrollbar scroll-smooth">
        <div class="mx-auto w-full p-4 md:p-8 min-h-full">

            <!-- View 1: Level Selection -->
            <div *ngIf="!selectedLevel" class="animate-fadeIn">
                <div class="flex flex-wrap justify-between gap-3 p-4">
                    <div class="flex min-w-72 flex-col gap-3">
                        <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">
                            Chọn trình độ luyện đọc của bạn
                        </p>
                        <p class="text-white/60 text-base font-normal leading-normal">
                            Bắt đầu hành trình cải thiện kỹ năng đọc với các bài đọc được phân loại theo từng cấp độ phù
                            hợp.
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-4">
                    <!-- Beginner -->
                    <div (click)="selectLevel(levels[0])"
                        class="flex flex-col gap-4 p-6 bg-white/5 rounded-xl border border-white/10 shadow-lg hover:bg-white/10 transition-colors duration-300 cursor-pointer group">
                        <div class="flex-grow">
                            <h3 class="text-white text-xl font-bold leading-normal mb-2">Cơ bản (Beginner)</h3>
                            <p class="text-white/60 text-sm font-normal leading-normal mb-3">
                                Dành cho người mới bắt đầu, tập trung vào từ vựng và cấu trúc câu đơn giản.
                            </p>
                            <p class="text-white/60 text-sm font-normal leading-normal">
                                {{ levels[0]?.topics?.length || 20 }}+ Chủ đề
                            </p>
                        </div>
                        <button
                            class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#13ecda] text-[#102220] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#13ecda]/90 transition-colors">
                            <span class="truncate">Khám phá</span>
                        </button>
                    </div>

                    <!-- Intermediate -->
                    <div (click)="selectLevel(levels[1])"
                        class="flex flex-col gap-4 p-6 bg-white/5 rounded-xl border border-white/10 shadow-lg hover:bg-white/10 transition-colors duration-300 cursor-pointer group">
                        <div class="flex-grow">
                            <h3 class="text-white text-xl font-bold leading-normal mb-2">Trung cấp (Intermediate)</h3>
                            <p class="text-white/60 text-sm font-normal leading-normal mb-3">
                                Dành cho người đã có nền tảng, mở rộng vốn từ và làm quen với các cấu trúc phức tạp hơn.
                            </p>
                            <p class="text-white/60 text-sm font-normal leading-normal">
                                {{ levels[1]?.topics?.length || 35 }}+ Chủ đề
                            </p>
                        </div>
                        <button
                            class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#13ecda] text-[#102220] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#13ecda]/90 transition-colors">
                            <span class="truncate">Khám phá</span>
                        </button>
                    </div>

                    <!-- Advanced -->
                    <div (click)="selectLevel(levels[2])"
                        class="flex flex-col gap-4 p-6 bg-white/5 rounded-xl border border-white/10 shadow-lg hover:bg-white/10 transition-colors duration-300 cursor-pointer group">
                        <div class="flex-grow">
                            <h3 class="text-white text-xl font-bold leading-normal mb-2">Nâng cao (Advanced)</h3>
                            <p class="text-white/60 text-sm font-normal leading-normal mb-3">
                                Thử thách bản thân với các bài đọc học thuật, văn bản dài và chủ đề chuyên sâu.
                            </p>
                            <p class="text-white/60 text-sm font-normal leading-normal">
                                {{ levels[2]?.topics?.length || 30 }}+ Chủ đề
                            </p>
                        </div>
                        <button
                            class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#13ecda] text-[#102220] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#13ecda]/90 transition-colors">
                            <span class="truncate">Khám phá</span>
                        </button>
                    </div>

                    <!-- Specialized (New) -->
                    <div
                        class="flex flex-col gap-4 p-6 bg-white/5 rounded-xl border border-white/10 shadow-lg transition-colors duration-300 opacity-50 cursor-not-allowed">
                        <div class="flex-grow">
                            <h3 class="text-white text-xl font-bold leading-normal mb-2">Chuyên ngành (Specialized)</h3>
                            <p class="text-white/60 text-sm font-normal leading-normal mb-3">
                                Khám phá các bài đọc theo lĩnh vực chuyên môn như Kinh tế, IT, Y học.
                            </p>
                            <p class="text-white/60 text-sm font-normal leading-normal">
                                15+ Chủ đề
                            </p>
                        </div>
                        <button disabled
                            class="flex w-full cursor-not-allowed items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-white/10 text-white/50 text-sm font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">Sắp ra mắt</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- View 2: Topic Selection -->
            <div *ngIf="selectedLevel && !selectedTopic" class="animate-fadeIn">
                <!-- Inner Breadcrumb & Title -->
                <div class="flex flex-col gap-8 p-4 md:p-6 lg:p-8">
                    <div class="flex flex-wrap gap-2">
                        <a class="text-[#92c9c5]/80 hover:text-[#13ecda] text-sm font-medium leading-normal cursor-pointer"
                            (click)="goBackToLevels()">Luyện đọc</a>
                        <span class="text-[#92c9c5]/80 text-sm font-medium leading-normal">/</span>
                        <span class="text-white text-sm font-medium leading-normal">{{ selectedLevel.name }}</span>
                    </div>
                    <div class="flex flex-wrap justify-between gap-3">
                        <div class="flex min-w-72 flex-col gap-3">
                            <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">{{
                                selectedLevel.name }}</p>
                            <p class="text-[#92c9c5] text-base font-normal leading-normal max-w-2xl">
                                {{ selectedLevel.description || 'Các bài đọc được chọn lọc kỹ càng giúp bạn nâng cao kỹ
                                năng.' }}
                            </p>
                        </div>
                    </div>

                    <!-- Topic Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div *ngFor="let topic of selectedLevel.topics" (click)="selectTopic(topic)"
                            class="group flex flex-col gap-4 p-6 bg-white/5 rounded-xl border border-solid border-white/10 hover:border-[#13ecda] transition-all duration-300 cursor-pointer">
                            <div class="flex justify-between items-start">
                                <div class="flex flex-col">
                                    <p class="text-white text-lg font-bold leading-normal">{{ topic.name }}</p>
                                    <p class="text-[#92c9c5] text-sm font-normal leading-normal">{{
                                        topic.conversations.length }} bài học</p>
                                </div>
                                <span
                                    class="material-symbols-outlined text-[#92c9c5] group-hover:text-[#13ecda] transition-colors">arrow_forward</span>
                            </div>
                            <!-- Progress Bar (Visual Placeholder) -->
                            <div class="w-full h-1 bg-white/10 rounded-full">
                                <div class="h-1 bg-[#13ecda] rounded-full" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View 3: Conversation Selection -->
            <div *ngIf="selectedTopic && !selectedConversation" class="animate-fadeIn">
                <div class="flex flex-col gap-8 p-4 md:p-6 lg:p-8">
                    <!-- Breadcrumb -->
                    <div class="flex flex-wrap gap-2 px-4">
                        <a class="text-[#92c9c5]/80 hover:text-[#13ecda] text-base font-medium leading-normal cursor-pointer transition-colors"
                            (click)="goBackToLevels()">Luyện đọc</a>
                        <span class="text-[#92c9c5]/80 text-base font-medium leading-normal">/</span>
                        <a class="text-[#92c9c5]/80 hover:text-[#13ecda] text-base font-medium leading-normal cursor-pointer transition-colors"
                            (click)="goBackToTopics()">{{ selectedLevel?.name }}</a>
                        <span class="text-[#92c9c5]/80 text-base font-medium leading-normal">/</span>
                        <span class="text-white text-base font-medium leading-normal">{{ selectedTopic.name }}</span>
                    </div>

                    <!-- Header -->
                    <div class="flex flex-wrap items-end justify-between gap-4 px-4">
                        <div class="flex flex-col gap-3">
                            <h1 class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">{{
                                selectedTopic.name }}</h1>
                            <p class="text-[#92c9c5] text-base font-normal leading-normal">{{
                                selectedTopic.conversations.length }} bài đọc</p>
                        </div>
                    </div>

                    <!-- Lesson List -->
                    <div class="flex flex-col divide-y divide-white/10 border-y border-white/10">
                        <div *ngFor="let conv of selectedTopic.conversations; let i = index"
                            class="flex items-center gap-4 px-4 min-h-[80px] py-3 justify-between hover:bg-white/5 transition-colors group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="text-[#13ecda] flex items-center justify-center font-bold text-2xl shrink-0 size-12">
                                    {{ i + 1 }}
                                </div>
                                <div class="flex flex-col justify-center">
                                    <p class="text-white text-base font-medium leading-normal line-clamp-1">{{
                                        conv.title }}</p>
                                    <p class="text-[#92c9c5] text-sm font-normal leading-normal line-clamp-2">
                                        {{ conv.sentences.length }} câu hỏi • ~{{ Math.ceil(conv.sentences.length * 10)
                                        }} từ • {{ Math.ceil(conv.sentences.length * 0.5) }} phút
                                    </p>
                                </div>
                            </div>
                            <div class="shrink-0">
                                <button (click)="selectConversation(conv)"
                                    class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-6 bg-[#13ecda] text-[#102220] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-[#13ecda]/90 transition-opacity">
                                    <span class="truncate">Bắt đầu</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View 4: Conversation View -->
            <div *ngIf="selectedConversation" class="max-w-4xl mx-auto pb-32 animate-fadeIn">
                <!-- Title Header -->
                <div class="flex flex-wrap justify-between gap-3 p-4 mb-8">
                    <div class="flex min-w-72 flex-col gap-3">
                        <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">
                            {{ selectedConversation.title }}
                        </p>
                        <p class="text-[#92c9c5] text-base font-normal leading-normal">
                            Practice your reading skills with this conversation.
                        </p>
                    </div>
                </div>

                <!-- Conversation Content Styles as Chat -->
                <div class="space-y-6">
                    <div *ngFor="let sentence of selectedConversation.sentences; let i = index"
                        class="flex gap-4 group transition-all duration-500 p-4 rounded-xl" [ngClass]="{
                            'flex-row-reverse': i % 2 !== 0,
                            'items-end': true,
                            'bg-white/5': isSpeaking && activeSentenceIndex === i
                        }">

                        <!-- Avatar -->
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 h-10 shrink-0 border border-white/10"
                            [ngClass]="{
                                'order-1': i % 2 === 0,
                                'order-2': i % 2 !== 0
                            }"
                            [style.background-image]="i % 2 === 0 ? 'url(https://lh3.googleusercontent.com/aida-public/AB6AXuAl_W_NKtDAhi64GRbsO-eUw0Ss9tI2zjvafgYHbCjFmuwKAXBGwCpe7rPfzZO7OaWhvMeQpZlHLltXFDtFho6YaSTY7hHeyuirlGqCPsfpJSdNHVXQq8OufJo_6HFtLab6tVsTpBw_lal_YiquRClWrqrQdvOk8LP_T4HQ6AOhpLdEuQSQcPB6cXGHh_HJeXCkVdq-zfaZx5WubBAR7ktween-fX4PdDcZ7mL-jAaj4wJvi5UYqfpIF0_hX7mNBTogFoC_08ZDoZVk)' : 'url(https://lh3.googleusercontent.com/aida-public/AB6AXuD2pj2x-sY8oLeU8f07esk3ozNZlKhpSkubxZa77_nJOC4bglPCE9ZCypgU0pYdg1qr_pMLWJHLvCVMMlhjAfvhpQiC7HlgpgaYTiXMyDrb-OsLrmTcqPZDsKOBR4oBB92PYMwXibwVGbkhqlfPjZf-g2g-5pLqlwuVNN0aYSfWrERKDNznpiOA9RQIFhTY4fdSPIoeRozwcFQEH3TbJiUtQe91mgmCG6zwDqGYHJFUsthBSYvnvHGWHS8I_0Db8TWgepXP-KCZyFGI)'">
                        </div>

                        <!-- Bubble -->
                        <div class="flex flex-1 flex-col gap-1 max-w-[85%]" [ngClass]="{
                            'items-start': i % 2 === 0,
                            'items-end': i % 2 !== 0
                        }">
                            <p class="text-[#13ecda] text-sm font-bold leading-normal max-w-[360px]" [ngClass]="{
                                'text-right': i % 2 !== 0
                            }">
                                {{ i % 2 === 0 ? 'A' : 'B' }}
                            </p>
                            <div class="text-base font-normal leading-normal flex flex-col rounded-lg px-4 py-3 text-white transition-all duration-300 shadow-md"
                                [ngClass]="{
                                    'bg-white/10 rounded-bl-none': i % 2 === 0,
                                    'bg-[#13ecda]/20 rounded-br-none': i % 2 !== 0,
                                    'ring-2 ring-[#13ecda]': isSpeaking && activeSentenceIndex === i
                                }">
                                <p>{{ sentence.en }}</p>
                                <p *ngIf="showTranslation"
                                    class="text-sm text-[#92c9c5] font-serif italic border-t border-white/10 pt-2 mt-2">
                                    {{ sentence.vi }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Floating Control Bar (Sticky Bottom) -->
                <div
                    class="sticky bottom-0 mt-auto bg-[#0f172a]/80 backdrop-blur-sm p-4 border-t border-white/10 flex justify-center z-30 w-full rounded-t-2xl">
                    <div class="max-w-[960px] mx-auto flex items-center justify-center gap-4 w-full">
                        <button (click)="toggleTranslation()"
                            class="flex items-center justify-center gap-2 flex-1 max-w-xs cursor-pointer overflow-hidden rounded-lg h-12 px-6 bg-white/10 text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-white/20 transition-colors">
                            <span class="material-symbols-outlined text-[1.2rem]">{{ showTranslation ? 'visibility_off'
                                : 'visibility' }}</span>
                            <span class="truncate hidden sm:inline">{{ showTranslation ? 'Ẩn dịch' : 'Hiện dịch'
                                }}</span>
                        </button>
                        <button (click)="readConversation()"
                            class="flex items-center justify-center gap-2 flex-1 max-w-xs cursor-pointer overflow-hidden rounded-lg h-12 px-6 bg-[#13ecda] text-[#102220] text-sm font-bold leading-normal tracking-[0.015em] shadow-[0_4px_14px_0_rgba(19,236,218,0.3)] hover:bg-[#13ecda]/90 transition-colors">
                            <span class="material-symbols-outlined text-[1.5rem]">{{ isSpeaking ? 'pause' : 'volume_up'
                                }}</span>
                            <span class="truncate">{{ isSpeaking ? 'Dừng lại' : 'Nghe' }}</span>
                        </button>
                    </div>
                </div>

            </div>

        </div>

        <!-- Scroll to Top Button -->
        <button *ngIf="showScrollTop" (click)="scrollToTop()"
            class="fixed bottom-24 right-6 z-40 h-12 w-12 rounded-full bg-slate-700/80 backdrop-blur text-white shadow-lg border border-white/10 flex items-center justify-center hover:bg-slate-600 transition-all">
            <span class="material-symbols-outlined">arrow_upward</span>
        </button>
    </main>
</div>